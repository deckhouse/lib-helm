suite: helm_lib_envs_for_proxy definition
templates:
  - helm_lib_envs_for_proxy.yaml
tests:
  - it: should render proxy env vars with http and https proxy
    set:
      global:
        clusterConfiguration:
          clusterDomain: "cluster.local"
          podSubnetCIDR: "10.0.0.0/16"
          serviceSubnetCIDR: "10.1.0.0/16"
          proxy:
            httpProxy: "http://proxy.example.com:8080"
            httpsProxy: "http://proxy.example.com:8080"
            noProxy:
              - "example.com"
    asserts:
      - equal:
          path: "proxyEnvs[0].name"
          value: "HTTP_PROXY"
      - equal:
          path: "proxyEnvs[0].value"
          value: "http://proxy.example.com:8080"
      - equal:
          path: "proxyEnvs[1].name"
          value: "http_proxy"
      - equal:
          path: "proxyEnvs[1].value"
          value: "http://proxy.example.com:8080"
      - equal:
          path: "proxyEnvs[2].name"
          value: "HTTPS_PROXY"
      - equal:
          path: "proxyEnvs[2].value"
          value: "http://proxy.example.com:8080"
      - equal:
          path: "proxyEnvs[3].name"
          value: "https_proxy"
      - equal:
          path: "proxyEnvs[3].value"
          value: "http://proxy.example.com:8080"
      - equal:
          path: "proxyEnvs[4].name"
          value: "NO_PROXY"
      - equal:
          path: "proxyEnvs[4].value"
          value: "127.0.0.1,169.254.169.254,cluster.local,10.0.0.0/16,10.1.0.0/16,example.com"
      - equal:
          path: "proxyEnvs[5].name"
          value: "no_proxy"
      - equal:
          path: "proxyEnvs[5].value"
          value: "127.0.0.1,169.254.169.254,cluster.local,10.0.0.0/16,10.1.0.0/16,example.com"

  - it: should render proxy env vars with only http proxy
    set:
      global:
        clusterConfiguration:
          clusterDomain: "cluster.local"
          podSubnetCIDR: "10.0.0.0/16"
          serviceSubnetCIDR: "10.1.0.0/16"
          proxy:
            httpProxy: "http://proxy.example.com:8080"
    asserts:
      - equal:
          path: "proxyEnvs[0].name"
          value: "HTTP_PROXY"
      - equal:
          path: "proxyEnvs[0].value"
          value: "http://proxy.example.com:8080"
      - equal:
          path: "proxyEnvs[1].name"
          value: "http_proxy"
      - equal:
          path: "proxyEnvs[1].value"
          value: "http://proxy.example.com:8080"
      - equal:
          path: "proxyEnvs[2].name"
          value: "NO_PROXY"
      - equal:
          path: "proxyEnvs[2].value"
          value: "127.0.0.1,169.254.169.254,cluster.local,10.0.0.0/16,10.1.0.0/16"
      - equal:
          path: "proxyEnvs[3].name"
          value: "no_proxy"
      - equal:
          path: "proxyEnvs[3].value"
          value: "127.0.0.1,169.254.169.254,cluster.local,10.0.0.0/16,10.1.0.0/16"

  - it: should not render proxy env vars when no proxy configured
    set:
      global:
        clusterConfiguration:
          clusterDomain: "cluster.local"
          podSubnetCIDR: "10.0.0.0/16"
          serviceSubnetCIDR: "10.1.0.0/16"
    asserts:
      - isEmpty:
          path: "proxyEnvs"