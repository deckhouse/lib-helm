suite: helm_lib_application_image definition
templates:
  - helm_lib_application_image.yaml
set:
  Runtime:
    Instance:
      Registry:
        base: "registry.deckhouse.io/deckhouse/ce"
      Digests:
        testApplication:
          testContainer: "sha123"
          externalContainer: "sha321"
        testModule:
          testContainer: "sha123"
          externalContainer: "sha321"
        fooBar:
          testContainer: "sha345"
        someApplication:
          externalContainer: "sha543"
        common:
          commonContainer: "sha999"
tests:
  - it: should render embedded application image
    documentIndex: 0
    asserts:
      - equal:
          path: "embeddedApplication"
          value: "registry.deckhouse.io/deckhouse/ce@sha123"
      - equal:
          path: "embeddedApplicationWithOptionalName"
          value: "registry.deckhouse.io/deckhouse/ce@sha345"

  - it: should render external application image
    documentIndex: 1
    set:
      testModule:
        registry:
          base: "registry.deckhouse.io/applications/"
      someApplication:
        registry:
          base: "registry.flant.com/applications/"
    asserts:
      - equal:
          path: "externalApplicationImage"
          value: "registry.deckhouse.io/applications/test-module@sha321"
      - equal:
          path: "externalApplicationImageWithOptionalName"
          value: "registry.flant.com/applications/some-application@sha543"
      - equal:
          path: "externalApplicationKebabImageWithOptionalName"
          value: "registry.flant.com/applications/some-application@sha543"

  - it: should render external application image with trail slash
    documentIndex: 1
    set:
      testModule:
        registry:
          base: "registry.deckhouse.io/modules/"
      someModule:
        registry:
          base: "registry.flant.com/modules/"
    asserts:
      - equal:
          path: "externalApplicationImage"
          value: "registry.deckhouse.io/modules/test-module@sha321"

  - it: should render external application image digest
    documentIndex: 2
    asserts:
      - equal:
          path: "externalApplicationImageDigest"
          value: "sha321"
      - equal:
          path: "externalApplicationImageDigestWithOptionalName"
          value: "sha543"
      - equal:
          path: "externalApplicationImageDigestWithOptionalNameTestApplication"
          value: "sha321"

  - it: should render external application image digest no fail
    documentIndex: 3
    asserts:
      - equal:
          path: "externalApplicationImageDigestNoFail"
          value: "sha321"
      - equal:
          path: "externalApplicationImageDigestWithOptionalNameNoFail"
          value: "sha543"
      - equal:
          path: "externalApplicationImageDigestWithOptionalNameTestApplicationNoFail"
          value: "sha321"
  - it: should render external module image digest no fail with null
    documentIndex: 4
    asserts:
      - equal:
          path: "externalApplicationImageDigestWithOptionalNameApplicationNotExistNoFail"
          value: null
      - equal:
          path: "externalApplicationImageDigestWithOptionalNameContainerNotExistNoFail"
          value: null
  - it: should render application image no fail
    documentIndex: 5
    asserts:
      - equal:
          path: "applicationImageNoFail"
          value: "registry.deckhouse.io/deckhouse/ce@sha123"
      - equal:
          path: "applicationImageNoFailNotExist"
          value: null
  - it: should render common application images
    documentIndex: 6
    asserts:
      - equal:
          path: "commonImage"
          value: "registry.deckhouse.io/deckhouse/ce@sha999"
      - equal:
          path: "commonImageNoFail"
          value: "registry.deckhouse.io/deckhouse/ce@sha999"
      - equal:
          path: "commonImageNoFailNotExist"
          value: null
