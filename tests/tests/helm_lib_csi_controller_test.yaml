suite: helm_lib_csi_controller_value definition
templates:
  - helm_lib_csi_controller_value.yaml
tests:
  - it: renders csi controller manifests

    set:
      global:
        modules:
          placement: {}
        modulesImages:
          registry:
            base: "deckhouse.io/deckhouse/ce"
          digests:
            common:
              csiExternalAttacher125: csiControllerAttacher125
              csiExternalProvisioner125: csiControllerProvisioner125
              csiExternalResizer125: csiControllerResizer125
              csiExternalSnapshotter125: csiControllerSnapshotter125
              csiVsphereSyncer125: csiControllerSyncer125
              csiLivenessprobe125: csiLivenessProbe125
        discovery:
          kubernetesVersion: "1.25"
          d8SpecificNodeCountByRole: {}
      _testvalues:
        controllerImage: controllerImage

    documentSelector:
      path: kind
      value: Deployment

    asserts:
      - hasDocuments:
          count: 2

      - containsDocument:
          kind: Deployment
          apiVersion: apps/v1
          name: csi-controller
          namespace: d8-test-module

      - equal:
          path: spec.template.spec.dnsPolicy
          value: "ClusterFirstWithHostNet"
  - it: renders csi controller manifests with dnsPolicy defined

    set:
      global:
        modules:
          placement: {}
        modulesImages:
          registry:
            base: "deckhouse.io/deckhouse/ce"
          digests:
            common:
              csiExternalAttacher125: csiControllerAttacher125
              csiExternalProvisioner125: csiControllerProvisioner125
              csiExternalResizer125: csiControllerResizer125
              csiExternalSnapshotter125: csiControllerSnapshotter125
              csiVsphereSyncer125: csiControllerSyncer125
              csiLivenessprobe125: csiLivenessProbe125
        discovery:
          kubernetesVersion: "1.25"
          d8SpecificNodeCountByRole: {}
      _testvalues:
        controllerImage: controllerImage
        dnsPolicy: Default

    documentSelector:
      path: kind
      value: Deployment

    asserts:
      - hasDocuments:
          count: 2

      - containsDocument:
          kind: Deployment
          apiVersion: apps/v1
          name: csi-controller
          namespace: d8-test-module

      - equal:
          path: spec.template.spec.dnsPolicy
          value: "Default"
